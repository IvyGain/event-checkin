# システム導線（ユーザーフロー）

## 概要

イベント参加者のQRチェックインシステム。管理者が参加者を登録してQRコードを発行し、当日スタッフがQRコードをスキャンしてチェックインを記録します。

---

## 主要な3つの導線

### 1. 管理者導線（事前準備）

```
① ホーム画面
   ↓ 「管理画面」をクリック
② 管理画面 (/admin)
   ↓ 「新規イベント」をクリック
③ イベント作成フォーム
   - イベント名入力
   - 日時選択
   - 場所入力
   ↓ 「作成」をクリック
④ イベントが作成される
   ↓ イベントを選択
⑤ 参加者追加
   ↓ 「参加者追加」をクリック
⑥ 参加者登録フォーム
   - 名前入力
   - メールアドレス入力
   - 会社名入力（任意）
   ↓ 「追加」をクリック
⑦ 参加者が登録され、QRトークンが自動生成される
   ↓ 参加者リストに表示
⑧ QRコード発行
   ↓ 「QR表示」をクリック
⑨ QRコード表示画面（新しいウィンドウ）
   - 参加者名
   - メールアドレス
   - QRコード画像
   ↓ 印刷 or スクリーンショット
⑩ QRコードを参加者にメール送信 or 受付で配布
```

**画面フロー図：**
```
[ホーム] → [管理画面]
              ├─ イベント管理
              │   ├─ 新規イベント作成
              │   └─ イベント選択
              ├─ 参加者管理
              │   ├─ 参加者追加
              │   ├─ 参加者一覧
              │   └─ QRコード表示
              └─ ダッシュボード
                  ├─ 総参加者数
                  ├─ チェックイン済み
                  └─ チェックイン率
```

---

### 2. スタッフ導線（当日チェックイン）

```
① ホーム画面
   ↓ 「チェックイン」をクリック
② チェックイン画面 (/checkin)
   ↓ 「スキャン開始」をクリック
③ カメラ起動
   - スマートフォンのカメラでQRコードをスキャン
   ↓ QRコードを読み取り
④ 自動的にバックエンドにPOST送信
   - トークン検証
   - データベース更新
   ↓ 処理完了
⑤ 結果表示

   【成功時】
   ✓ チェックイン完了！
   - イベント名
   - 参加者名
   - メールアドレス
   - 会社名
   - チェックイン時刻
   ↓ 「次の参加者をスキャン」をクリック
   ② に戻る

   【失敗時】
   ✗ エラー
   - エラーメッセージ表示
     例: 「既にチェックイン済みです」
     例: 「参加者が見つかりません」
   ↓ 「再試行」をクリック
   ② に戻る
```

**チェックインフロー図：**
```
[ホーム] → [チェックイン画面]
              ↓
          [スキャン開始]
              ↓
          [カメラ起動]
              ↓
          [QRコード読取]
              ↓
       ┌──────┴──────┐
    [成功]          [失敗]
       │               │
   [完了画面]      [エラー画面]
       │               │
   [次をスキャン]   [再試行]
       └───────┬───────┘
           [繰り返し]
```

---

### 3. 参加者導線（QRコード受取）

```
① メールまたは受付でQRコードを受け取る
   - 印刷された紙
   - メールのQRコード画像
   - PDFファイル

② イベント当日、受付に到着

③ QRコードを提示
   - スマートフォン画面で表示
   - または印刷した紙を見せる

④ スタッフがスキャン

⑤ チェックイン完了の確認
   - スタッフの画面に成功メッセージ
   - 口頭で「チェックイン完了しました」

⑥ イベント会場へ入場
```

---

## データフロー（技術詳細）

### QRコード生成フロー
```
1. 参加者登録
   POST /api/participants
   {
     eventId: "xxx",
     name: "山田太郎",
     email: "yamada@example.com",
     company: "株式会社サンプル"
   }

2. サーバー側でQRトークン生成
   generateQRToken(eventId, email)
   ↓
   UUID + eventId + email + timestamp
   ↓
   SHA256ハッシュ化
   ↓
   64文字の一意なトークン生成

3. データベースに保存
   Participant {
     id: UUID
     qrToken: "a1b2c3d4..." (64文字)
     checkedIn: false
   }

4. QRコード画像生成
   GET /api/qr?participantId=xxx
   ↓
   generateQRCode(token)
   ↓
   URL: https://your-app.com/checkin?token=a1b2c3d4...
   ↓
   QRコード画像（DataURL）
```

### チェックインフロー
```
1. QRスキャン
   html5-qrcodeライブラリでQRコード読取
   ↓
   URL: https://your-app.com/checkin?token=a1b2c3d4...
   ↓
   トークン抽出: a1b2c3d4...

2. チェックインAPI呼び出し
   POST /api/checkin
   {
     token: "a1b2c3d4...",
     deviceInfo: "Mozilla/5.0..."
   }

3. サーバー側処理
   ① トークン形式検証（SHA256の64文字？）
   ② データベースからParticipant検索
   ③ 既にチェックイン済みかチェック
   ④ トランザクション開始
      - Participant.checkedIn = true
      - Participant.checkedInAt = now()
      - CheckInLog.create()
   ⑤ コミット

4. レスポンス
   {
     success: true,
     participant: {
       name: "山田太郎",
       email: "yamada@example.com",
       checkedInAt: "2024-01-01T10:00:00Z"
     }
   }
```

---

## データベース関連図

```
Event (イベント)
  ├─ id (UUID)
  ├─ name
  ├─ date
  ├─ location
  └─ participants[] ───┐
                       │
Participant (参加者) ←┘
  ├─ id (UUID)
  ├─ eventId ────→ Event
  ├─ name
  ├─ email
  ├─ company (nullable)
  ├─ qrToken (unique, indexed)
  ├─ checkedIn (boolean)
  ├─ checkedInAt (nullable)
  └─ checkInLogs[] ───┐
                      │
CheckInLog (履歴) ←──┘
  ├─ id (UUID)
  ├─ participantId ────→ Participant
  ├─ checkedInAt
  └─ deviceInfo
```

---

## API エンドポイント一覧

### イベント管理
- `GET /api/events` - イベント一覧（統計付き）
- `POST /api/events` - イベント作成

### 参加者管理
- `GET /api/participants?eventId=xxx` - 参加者一覧
- `POST /api/participants` - 参加者登録（QRトークン自動生成）

### QRコード
- `GET /api/qr?participantId=xxx` - 個別QRコード生成
- `POST /api/qr/bulk` - 一括QRコード生成

### チェックイン
- `POST /api/checkin` - チェックイン実行
- `GET /api/checkin/stats?eventId=xxx` - 統計取得

---

## セキュリティフロー

### QRトークンセキュリティ
```
1. トークン生成時
   UUID + eventId + email + timestamp
   ↓
   SHA256ハッシュ（不可逆）
   ↓
   元の情報からトークンを推測不可能

2. スキャン時
   トークン検証
   ↓
   ① 形式チェック（64文字の16進数？）
   ② データベースに存在するか？
   ③ 既にチェックイン済みか？
   ↓
   すべてOKでチェックイン許可

3. 重複防止
   Transaction使用
   ↓
   checkedIn = trueを先に更新
   ↓
   2回目のスキャンは「既にチェックイン済み」でエラー
```

---

## 画面遷移マップ

```
                    [ホーム]
                  /         \
                 /           \
          [チェックイン]    [管理画面]
               |               /  |  \
         [QRスキャナー]       /   |   \
               |          [イベント] | [参加者]
         [結果表示]         管理    |   管理
               |              \    |    /
          [次をスキャン]        [ダッシュボード]
               ↓                    |
          [繰り返し]          [統計・QR表示]
```

---

## エラーハンドリング

### チェックイン時のエラー
1. **参加者が見つからない**
   - 原因: 無効なQRコード、削除された参加者
   - 対応: エラーメッセージ表示、再スキャン

2. **既にチェックイン済み**
   - 原因: 同じQRコードを2回スキャン
   - 対応: 既にチェックイン済みの旨を表示、チェックイン時刻を表示

3. **ネットワークエラー**
   - 原因: インターネット接続切断
   - 対応: エラーメッセージ表示、再試行ボタン

4. **カメラアクセスエラー**
   - 原因: カメラ権限がない、カメラが使用中
   - 対応: 権限要求、ブラウザ設定案内

---

## パフォーマンス考慮点

1. **QRコード生成**
   - 個別生成: 即座に生成・表示
   - 一括生成: 非同期で並列処理

2. **チェックイン**
   - トランザクション使用で整合性保証
   - インデックス（qrToken）で高速検索

3. **ダッシュボード**
   - リアルタイム更新（手動リロード）
   - 統計情報はSQL集計で高速計算

---

このドキュメントはシステムの完全な導線を説明しています。
追加機能や変更があった場合は、このファイルも更新してください。
